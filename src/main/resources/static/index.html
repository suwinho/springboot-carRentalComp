<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Car Rental - Home</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"
      type="text/javascript"
    ></script>

    <style>
      :root {
        --dark-bg: #121212;
        --dark-card: #1e1e1e;
        --accent-purple: #bb86fc;
        --accent-hover: #9955e8;
        --text-main: #e0e0e0;
        --text-muted: #a0a0a0;
        --border-color: #333;
      }

      body.bg-light {
        background-color: var(--dark-bg) !important;
        color: var(--text-main) !important;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }

      .navbar-dark.bg-dark {
        background-color: #000000 !important;
        border-bottom: 1px solid var(--border-color);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
      }

      .navbar-brand {
        font-weight: bold;
        color: var(--accent-purple) !important;
        letter-spacing: 1px;
      }

      .card {
        background-color: var(--dark-card);
        border: 1px solid var(--border-color);
        color: var(--text-main);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
      }

      .car-card:hover {
        transform: translateY(-5px) scale(1.02);
        box-shadow: 0 10px 20px rgba(187, 134, 252, 0.15);
        border-color: var(--accent-purple);
        cursor: pointer;
      }

      .card-title {
        color: #fff;
        font-weight: 600;
      }
      .text-muted {
        color: var(--text-muted) !important;
      }

      .btn-primary {
        background-color: var(--accent-purple);
        border-color: var(--accent-purple);
        color: #000;
        font-weight: bold;
        text-transform: uppercase;
        font-size: 0.9rem;
      }

      .btn-primary:hover {
        background-color: var(--accent-hover);
        border-color: var(--accent-hover);
        color: #fff;
        box-shadow: 0 0 15px rgba(187, 134, 252, 0.4);
      }

      h2 {
        color: var(--text-main);
        border-bottom: 2px solid var(--accent-purple);
        display: inline-block;
        padding-bottom: 10px;
      }

      #notification-area {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 1000;
      }
    </style>
  </head>
  <body class="bg-light">
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4">
      <div class="container">
        <a class="navbar-brand" href="index.html">üöó CarRental Pro</a>
        <div class="navbar-nav ms-auto">
          <a class="nav-link active" href="index.html">Car List</a>
          <a class="nav-link" href="add-car.html">Add Car</a>
        </div>
      </div>
    </nav>

    <div class="container">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Available Cars</h2>
        <span id="mqtt-status" class="badge bg-secondary"
          >Connecting to MQTT...</span
        >
      </div>

      <div id="carsGrid" class="row g-4">
        <div class="text-center mt-5">
          <div class="spinner-border text-primary"></div>
        </div>
      </div>
    </div>

    <div id="notification-area"></div>

    <script>
      const API_URL = "http://localhost:8080/api";

      // Fetch car list
      async function loadCars() {
        try {
          const response = await fetch(`${API_URL}/cars`);
          const cars = await response.json();
          renderGrid(cars);
        } catch (error) {
          console.error("REST API Error:", error);
        }
      }

      function renderGrid(cars) {
        const grid = document.getElementById("carsGrid");
        grid.innerHTML = "";

        if (cars.length === 0) {
          grid.innerHTML =
            '<p class="text-center text-muted">No cars in database.</p>';
          return;
        }

        cars.reverse().forEach((car) => {
          const displayPrice = car.basePrice ? car.basePrice + " PLN" : "-";
          const card = `
                <div class="col-md-4 fade-in-car">
                    <div class="card car-card shadow-sm h-100">
                        <div class="card-body">
                            <h5 class="card-title">${car.brand} ${car.model}</h5>
                            <p class="card-text text-muted">ID: ${car.id}</p>
                            <p class="card-text fs-4 fw-bold" style="color: var(--accent-purple)">
                                ${displayPrice}
                            </p>
                            <div class="d-grid gap-2">
                                <a href="reservation.html?id=${car.id}&make=${car.brand}&model=${car.model}" 
                                   class="btn btn-primary">Book Now</a>
                            </div>
                        </div>
                    </div>
                </div>
            `;
          grid.innerHTML += card;
        });
      }

      // MQTT Logic
      const MQTT_BROKER = "broker.hivemq.com";
      const MQTT_PORT = 8000;
      const MQTT_TOPIC = "wypozyczalnia/auta";
      const CLIENT_ID = "WebClient_" + new Date().getTime();

      const client = new Paho.MQTT.Client(MQTT_BROKER, MQTT_PORT, CLIENT_ID);

      client.onConnectionLost = function (responseObject) {
        console.log("‚ùå MQTT Disconnected: " + responseObject.errorMessage);
        document.getElementById("mqtt-status").innerText = "Disconnected";
        document.getElementById("mqtt-status").className = "badge bg-danger";
      };

      client.onMessageArrived = function (message) {
        console.log("üì© MQTT Received: " + message.payloadString);

        // Show notification
        const area = document.getElementById("notification-area");
        const toast = document.createElement("div");
        toast.className = "alert alert-success shadow";
        toast.innerHTML = `üöó <strong>New car added! Refreshing...</strong>`;
        area.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);

        // Refresh list
        loadCars();
      };

      // Connection
      console.log("‚è≥ Connecting to MQTT...");
      client.connect({
        onSuccess: function () {
          console.log("‚úÖ Connected to MQTT!");
          document.getElementById("mqtt-status").innerText = "üü¢ Live";
          document.getElementById("mqtt-status").className = "badge bg-success";
          client.subscribe(MQTT_TOPIC);
        },
        onFailure: function (message) {
          console.error("‚ùå Connection failed: " + message.errorMessage);
          document.getElementById("mqtt-status").innerText = "Error";
          document.getElementById("mqtt-status").className = "badge bg-danger";
        },
        useSSL: false,
      });

      // Start
      loadCars();
    </script>
  </body>
</html>
